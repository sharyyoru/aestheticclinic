-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.appointments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  provider_id uuid,
  start_time timestamp with time zone NOT NULL,
  end_time timestamp with time zone,
  status USER-DEFINED NOT NULL DEFAULT 'scheduled'::appointment_status,
  reason text,
  location text,
  source text DEFAULT 'manual'::text CHECK (source = ANY (ARRAY['manual'::text, 'ai'::text])),
  created_at timestamp with time zone DEFAULT now(),
  is_demo boolean NOT NULL DEFAULT false,
  category text,
  temporary_text text,
  migrated boolean DEFAULT false,
  CONSTRAINT appointments_pkey PRIMARY KEY (id),
  CONSTRAINT appointments_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT appointments_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES public.providers(id)
);
CREATE TABLE public.chat_conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  folder_id uuid,
  title text,
  patient_id uuid,
  deal_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_archived boolean NOT NULL DEFAULT false,
  archived_at timestamp with time zone,
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT chat_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT chat_conversations_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id),
  CONSTRAINT chat_conversations_folder_id_fkey FOREIGN KEY (folder_id) REFERENCES public.chat_folders(id),
  CONSTRAINT chat_conversations_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT chat_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.chat_folders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_folders_pkey PRIMARY KEY (id),
  CONSTRAINT chat_folders_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.chat_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  role USER-DEFINED NOT NULL,
  content text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT chat_messages_pkey PRIMARY KEY (id),
  CONSTRAINT chat_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chat_conversations(id)
);
CREATE TABLE public.clinic_onboarding_submissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  token_id uuid,
  status text NOT NULL DEFAULT 'in_progress'::text CHECK (status = ANY (ARRAY['in_progress'::text, 'completed'::text, 'archived'::text])),
  current_step integer NOT NULL DEFAULT 1,
  practice_name text,
  practice_location text,
  practice_address text,
  practice_phone text,
  practice_email text,
  practice_website text,
  main_contact_name text,
  main_contact_email text,
  main_contact_phone text,
  main_contact_role text,
  expected_user_count integer,
  user_directory jsonb DEFAULT '[]'::jsonb,
  access_levels jsonb DEFAULT '[]'::jsonb,
  departments jsonb DEFAULT '[]'::jsonb,
  current_software text,
  current_software_other text,
  data_access_authorized boolean DEFAULT false,
  migration_contact_name text,
  migration_contact_email text,
  storage_estimate text,
  patient_file_count integer,
  service_categories jsonb DEFAULT '[]'::jsonb,
  services_list jsonb DEFAULT '[]'::jsonb,
  services_file_url text,
  lead_sources jsonb DEFAULT '[]'::jsonb,
  marketing_automations jsonb DEFAULT '[]'::jsonb,
  additional_notes text,
  gdpr_consent boolean DEFAULT false,
  hipaa_acknowledgment boolean DEFAULT false,
  terms_accepted boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT clinic_onboarding_submissions_pkey PRIMARY KEY (id),
  CONSTRAINT clinic_onboarding_submissions_token_id_fkey FOREIGN KEY (token_id) REFERENCES public.clinic_onboarding_tokens(id)
);
CREATE TABLE public.clinic_onboarding_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL,
  token text NOT NULL UNIQUE,
  expires_at timestamp with time zone NOT NULL,
  used_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT clinic_onboarding_tokens_pkey PRIMARY KEY (id)
);
CREATE TABLE public.consultations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  consultation_id text NOT NULL,
  title text NOT NULL,
  record_type USER-DEFINED NOT NULL,
  doctor_user_id uuid,
  doctor_name text,
  scheduled_at timestamp with time zone,
  payment_method text,
  created_by_user_id uuid,
  created_by_name text,
  created_at timestamp with time zone DEFAULT now(),
  content text,
  duration_seconds integer,
  is_archived boolean NOT NULL DEFAULT false,
  archived_at timestamp with time zone,
  invoice_total_amount numeric,
  invoice_is_complimentary boolean NOT NULL DEFAULT false,
  invoice_is_paid boolean NOT NULL DEFAULT false,
  cash_receipt_path text,
  payment_link_token text UNIQUE,
  payment_link_expires_at timestamp with time zone,
  invoice_pdf_path text,
  stripe_payment_intent_id text,
  payment_completed_at timestamp with time zone,
  is_demo boolean NOT NULL DEFAULT false,
  payrexx_gateway_id integer,
  payrexx_gateway_hash text,
  payrexx_payment_link text,
  payrexx_transaction_id integer,
  payrexx_transaction_uuid text,
  payrexx_payment_status text CHECK (payrexx_payment_status = ANY (ARRAY['waiting'::text, 'confirmed'::text, 'authorized'::text, 'reserved'::text, 'refunded'::text, 'partially-refunded'::text, 'cancelled'::text, 'declined'::text, 'error'::text, 'uncaptured'::text])),
  payrexx_paid_at timestamp with time zone,
  raw_data text,
  axenita_invoice_id text,
  invoice_status text,
  paid_at timestamp with time zone,
  paid_by_user_id uuid,
  insurance_payment_status text,
  insurance_paid_amount numeric,
  insurance_paid_date date,
  treatment_id text,
  attatched_treatment_title_id text,
  treatment_title_id text,
  invoice_paid_amount double precision,
  CONSTRAINT consultations_pkey PRIMARY KEY (id),
  CONSTRAINT consultations_paid_by_user_id_fkey FOREIGN KEY (paid_by_user_id) REFERENCES auth.users(id),
  CONSTRAINT consultations_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id),
  CONSTRAINT consultations_doctor_user_id_fkey FOREIGN KEY (doctor_user_id) REFERENCES public.users(id),
  CONSTRAINT consultations_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.crisalix_reconstructions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  crisalix_patient_id integer NOT NULL,
  reconstruction_type text NOT NULL,
  player_id text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT crisalix_reconstructions_pkey PRIMARY KEY (id),
  CONSTRAINT crisalix_reconstructions_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.deal_stages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  type USER-DEFINED NOT NULL DEFAULT 'other'::deal_stage_type,
  sort_order integer NOT NULL,
  is_default boolean NOT NULL DEFAULT false,
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT deal_stages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.deals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  stage_id uuid NOT NULL,
  title text,
  value numeric,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  pipeline text,
  contact_label text,
  location text,
  service_id uuid,
  is_demo boolean NOT NULL DEFAULT false,
  owner_id uuid,
  owner_name text,
  CONSTRAINT deals_pkey PRIMARY KEY (id),
  CONSTRAINT deals_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.users(id),
  CONSTRAINT deals_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT deals_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id),
  CONSTRAINT deals_stage_id_fkey FOREIGN KEY (stage_id) REFERENCES public.deal_stages(id)
);
CREATE TABLE public.document_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  file_path text NOT NULL,
  file_type text NOT NULL DEFAULT 'docx'::text,
  category text,
  is_active boolean NOT NULL DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT document_templates_pkey PRIMARY KEY (id),
  CONSTRAINT document_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  deal_id uuid,
  type USER-DEFINED NOT NULL DEFAULT 'other'::document_type,
  title text NOT NULL,
  content text NOT NULL,
  created_by_user_id uuid,
  created_by text,
  created_at timestamp with time zone DEFAULT now(),
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT documents_pkey PRIMARY KEY (id),
  CONSTRAINT documents_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id),
  CONSTRAINT documents_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id),
  CONSTRAINT documents_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.email_attachments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email_id uuid NOT NULL,
  file_name text NOT NULL,
  storage_path text NOT NULL,
  mime_type text,
  file_size bigint,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_attachments_pkey PRIMARY KEY (id),
  CONSTRAINT email_attachments_email_id_fkey FOREIGN KEY (email_id) REFERENCES public.emails(id)
);
CREATE TABLE public.email_reply_notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  patient_id uuid,
  original_email_id uuid,
  reply_email_id uuid,
  read_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_reply_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT email_reply_notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT email_reply_notifications_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT email_reply_notifications_original_email_id_fkey FOREIGN KEY (original_email_id) REFERENCES public.emails(id),
  CONSTRAINT email_reply_notifications_reply_email_id_fkey FOREIGN KEY (reply_email_id) REFERENCES public.emails(id)
);
CREATE TABLE public.email_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  type USER-DEFINED NOT NULL,
  subject_template text NOT NULL,
  body_template text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  design_json jsonb,
  html_content text,
  updated_at timestamp with time zone DEFAULT now(),
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT email_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.emails (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  deal_id uuid,
  to_address text NOT NULL,
  from_address text,
  subject text NOT NULL,
  body text NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'draft'::email_status,
  direction USER-DEFINED NOT NULL DEFAULT 'outbound'::email_direction,
  sent_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  message_id text,
  is_demo boolean NOT NULL DEFAULT false,
  read_at timestamp with time zone,
  CONSTRAINT emails_pkey PRIMARY KEY (id),
  CONSTRAINT emails_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id),
  CONSTRAINT emails_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.invoice_line_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  invoice_id uuid NOT NULL,
  sort_order integer NOT NULL DEFAULT 1,
  code text,
  code_on_invoice integer,
  service_id uuid,
  name text NOT NULL,
  name_fr text,
  name_de text,
  name_it text,
  description_fr text,
  description_de text,
  description_it text,
  quantity numeric NOT NULL DEFAULT 1,
  unit_price numeric NOT NULL,
  discount_percent numeric DEFAULT 0,
  total_price numeric NOT NULL,
  total_price_without_vat numeric,
  vat_rate text DEFAULT 'FREE'::text CHECK (vat_rate = ANY (ARRAY['FREE'::text, 'NORMAL'::text, 'REDUCED'::text])),
  vat_rate_value numeric DEFAULT 0,
  vat_amount numeric DEFAULT 0,
  tariff_code integer,
  tarmed_code text,
  tarmed_time integer DEFAULT 0,
  tp_al numeric DEFAULT 0,
  tp_tl numeric DEFAULT 0,
  tp_al_value numeric DEFAULT 1,
  tp_tl_value numeric DEFAULT 1,
  tp_al_scale_factor numeric DEFAULT 1,
  tp_tl_scale_factor numeric DEFAULT 1,
  tp_al_or_price numeric DEFAULT 0,
  price_al numeric DEFAULT 0,
  price_tl numeric DEFAULT 0,
  catalog_name text,
  catalog_nature text CHECK (catalog_nature = ANY (ARRAY['TARIFF_CATALOG'::text, 'CUSTOM'::text])),
  catalog_version text,
  catalog_valid_from date,
  catalog_valid_to date,
  body_half text DEFAULT 'NOT_SPECIFIED'::text,
  uncovered_benefit boolean DEFAULT false,
  effective_duration_minutes numeric DEFAULT 0,
  comment text,
  accounted_medical_benefit_id uuid,
  source_unaccounted_medical_benefit_id uuid,
  raw_data jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT invoice_line_items_pkey PRIMARY KEY (id),
  CONSTRAINT invoice_line_items_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.invoices(id),
  CONSTRAINT invoice_line_items_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id)
);
CREATE TABLE public.invoice_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  invoice_id uuid NOT NULL,
  amount numeric NOT NULL,
  payment_method text,
  payment_date date NOT NULL DEFAULT CURRENT_DATE,
  payrexx_transaction_id text,
  insurance_response_code text,
  insurance_response_message text,
  notes text,
  created_by_user_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT invoice_payments_pkey PRIMARY KEY (id),
  CONSTRAINT invoice_payments_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.invoices(id),
  CONSTRAINT invoice_payments_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.invoices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  consultation_id uuid,
  treatment_id uuid,
  medical_case_id uuid,
  invoice_number text NOT NULL,
  invoice_number_legacy text,
  invoice_date date NOT NULL DEFAULT CURRENT_DATE,
  due_date date,
  medical_case_number text,
  medical_case_subject text,
  health_insurance_law text CHECK (health_insurance_law = ANY (ARRAY['KVG'::text, 'UVG'::text, 'IVG'::text, 'MVG'::text, 'VVG'::text])),
  billing_type text DEFAULT 'TG'::text CHECK (billing_type = ANY (ARRAY['TG'::text, 'TP'::text])),
  care_provider_id uuid,
  care_provider_name text,
  care_provider_gln text,
  care_provider_zsr text,
  care_provider_short_name text,
  care_provider_color_code integer,
  executing_mandator_id uuid,
  executing_mandator_name text,
  executing_mandator_gln text,
  executing_mandator_zsr text,
  executing_mandator_short_name text,
  executing_mandator_color_code integer,
  executing_mandator_internal_contact_id uuid,
  responsible_mandator_id uuid,
  responsible_mandator_name text,
  responsible_mandator_gln text,
  responsible_mandator_zsr text,
  responsible_mandator_short_name text,
  responsible_mandator_color_code integer,
  responsible_mandator_internal_contact_id uuid,
  billing_group_id uuid,
  billing_group_name text,
  insurer_id uuid,
  subtotal numeric NOT NULL DEFAULT 0,
  vat_amount numeric NOT NULL DEFAULT 0,
  total_amount numeric NOT NULL DEFAULT 0,
  total_amount_raw numeric,
  paid_amount numeric DEFAULT 0,
  status text NOT NULL DEFAULT 'OPEN'::text CHECK (status = ANY (ARRAY['OPEN'::text, 'PAID'::text, 'CANCELLED'::text, 'PARTIAL_PAID'::text, 'PARTIAL_LOSS'::text, 'OVERPAID'::text])),
  status_change_date date,
  is_complimentary boolean NOT NULL DEFAULT false,
  payment_method text,
  payment_link_token text UNIQUE,
  payment_link_expires_at timestamp with time zone,
  payrexx_gateway_id integer,
  payrexx_gateway_hash text,
  payrexx_payment_link text,
  payrexx_transaction_id text,
  payrexx_transaction_uuid text,
  payrexx_payment_status text,
  payrexx_paid_at timestamp with time zone,
  pdf_path text,
  pdf_generated_at timestamp with time zone,
  medidata_submission_id uuid,
  cash_receipt_path text,
  content_html text,
  raw_data jsonb,
  source_instance_id uuid,
  created_by_user_id uuid,
  created_by_name text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_archived boolean NOT NULL DEFAULT false,
  archived_at timestamp with time zone,
  CONSTRAINT invoices_pkey PRIMARY KEY (id),
  CONSTRAINT invoices_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT invoices_consultation_id_fkey FOREIGN KEY (consultation_id) REFERENCES public.consultations(id),
  CONSTRAINT invoices_care_provider_id_fkey FOREIGN KEY (care_provider_id) REFERENCES public.providers(id),
  CONSTRAINT invoices_insurer_id_fkey FOREIGN KEY (insurer_id) REFERENCES public.swiss_insurers(id),
  CONSTRAINT invoices_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.lead_imports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  filename text NOT NULL,
  service text NOT NULL,
  total_leads integer NOT NULL DEFAULT 0,
  imported_count integer NOT NULL DEFAULT 0,
  failed_count integer NOT NULL DEFAULT 0,
  imported_patient_ids ARRAY DEFAULT ARRAY[]::uuid[],
  errors ARRAY,
  import_date timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT lead_imports_pkey PRIMARY KEY (id)
);
CREATE TABLE public.medidata_config (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  clinic_gln text NOT NULL,
  clinic_zsr text NOT NULL,
  clinic_name text NOT NULL,
  clinic_address_street text,
  clinic_address_postal_code text,
  clinic_address_city text,
  clinic_canton text,
  medidata_client_id text,
  medidata_username text,
  medidata_password_encrypted text,
  medidata_endpoint_url text DEFAULT 'https://medidata.ch/md/ela'::text,
  is_test_mode boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT medidata_config_pkey PRIMARY KEY (id)
);
CREATE TABLE public.medidata_submission_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  submission_id uuid NOT NULL,
  previous_status text,
  new_status text NOT NULL,
  response_code text,
  response_message text,
  changed_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT medidata_submission_history_pkey PRIMARY KEY (id),
  CONSTRAINT medidata_submission_history_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.medidata_submissions(id),
  CONSTRAINT medidata_submission_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(id)
);
CREATE TABLE public.medidata_submissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  consultation_id uuid NOT NULL,
  patient_id uuid NOT NULL,
  insurer_id uuid,
  invoice_number text NOT NULL,
  invoice_date date NOT NULL,
  invoice_amount numeric NOT NULL,
  billing_type text NOT NULL CHECK (billing_type = ANY (ARRAY['TG'::text, 'TP'::text])),
  law_type text NOT NULL CHECK (law_type = ANY (ARRAY['KVG'::text, 'UVG'::text, 'IVG'::text, 'MVG'::text, 'VVG'::text])),
  xml_content text,
  xml_version text DEFAULT '4.50'::text,
  medidata_message_id text,
  medidata_transmission_date timestamp with time zone,
  medidata_response_code text,
  medidata_response_message text,
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'pending'::text, 'transmitted'::text, 'delivered'::text, 'accepted'::text, 'partially_paid'::text, 'paid'::text, 'rejected'::text, 'disputed'::text, 'reminder_1'::text, 'reminder_2'::text, 'reminder_3'::text, 'collection'::text, 'cancelled'::text])),
  insurance_response_date timestamp with time zone,
  insurance_response_code text,
  insurance_response_message text,
  insurance_paid_amount numeric,
  insurance_paid_date date,
  patient_portion_amount numeric,
  patient_portion_paid boolean DEFAULT false,
  patient_portion_paid_date date,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT medidata_submissions_pkey PRIMARY KEY (id),
  CONSTRAINT medidata_submissions_consultation_id_fkey FOREIGN KEY (consultation_id) REFERENCES public.consultations(id),
  CONSTRAINT medidata_submissions_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT medidata_submissions_insurer_id_fkey FOREIGN KEY (insurer_id) REFERENCES public.swiss_insurers(id),
  CONSTRAINT medidata_submissions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.patient_consultation_data (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  submission_id uuid,
  consultation_type text NOT NULL,
  selected_areas ARRAY,
  measurements jsonb,
  upload_mode text DEFAULT 'later'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  breast_data jsonb,
  face_data jsonb,
  CONSTRAINT patient_consultation_data_pkey PRIMARY KEY (id),
  CONSTRAINT patient_consultation_data_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT patient_consultation_data_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id)
);
CREATE TABLE public.patient_document_versions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  document_id uuid NOT NULL,
  version integer NOT NULL,
  content text,
  changed_by uuid,
  changed_by_name text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_document_versions_pkey PRIMARY KEY (id),
  CONSTRAINT patient_document_versions_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.patient_documents(id),
  CONSTRAINT patient_document_versions_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(id)
);
CREATE TABLE public.patient_documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  template_id uuid,
  title text NOT NULL,
  content text,
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'final'::text, 'signed'::text, 'archived'::text])),
  file_path text,
  version integer NOT NULL DEFAULT 1,
  created_by uuid,
  created_by_name text,
  last_edited_by uuid,
  last_edited_at timestamp with time zone,
  signed_at timestamp with time zone,
  signed_by_patient boolean DEFAULT false,
  signed_by_doctor boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  docspace_file_id text,
  CONSTRAINT patient_documents_pkey PRIMARY KEY (id),
  CONSTRAINT patient_documents_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT patient_documents_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.document_templates(id),
  CONSTRAINT patient_documents_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT patient_documents_last_edited_by_fkey FOREIGN KEY (last_edited_by) REFERENCES public.users(id)
);
CREATE TABLE public.patient_edit_locks (
  patient_id uuid NOT NULL,
  user_id uuid NOT NULL,
  user_name text,
  user_avatar_url text,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT patient_edit_locks_pkey PRIMARY KEY (patient_id),
  CONSTRAINT patient_edit_locks_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT patient_edit_locks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.patient_health_background (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  submission_id uuid,
  weight_kg numeric,
  height_cm numeric,
  bmi numeric,
  known_illnesses text,
  previous_surgeries text,
  allergies text,
  medications text,
  cigarettes text,
  alcohol_consumption text,
  sports_activity text,
  general_practitioner text,
  gynecologist text,
  children_count integer,
  birth_type_1 text,
  birth_type_2 text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_health_background_pkey PRIMARY KEY (id),
  CONSTRAINT patient_health_background_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT patient_health_background_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id)
);
CREATE TABLE public.patient_insurances (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  provider_name text,
  card_number text,
  insurance_type text CHECK (insurance_type IS NULL OR (insurance_type = ANY (ARRAY['private'::text, 'semi-private'::text, 'basic'::text]))),
  created_at timestamp with time zone DEFAULT now(),
  insurer_id uuid,
  gln text,
  avs_number text,
  policy_number text,
  law_type text CHECK (law_type = ANY (ARRAY['KVG'::text, 'UVG'::text, 'IVG'::text, 'MVG'::text, 'VVG'::text])),
  billing_type text DEFAULT 'TG'::text CHECK (billing_type = ANY (ARRAY['TG'::text, 'TP'::text])),
  case_number text,
  accident_date date,
  is_primary boolean DEFAULT true,
  insurer_gln text,
  valid_from timestamp without time zone,
  valid_till timestamp without time zone,
  kvg_insurance_model text,
  CONSTRAINT patient_insurances_pkey PRIMARY KEY (id),
  CONSTRAINT patient_insurances_insurer_id_fkey FOREIGN KEY (insurer_id) REFERENCES public.swiss_insurers(id),
  CONSTRAINT patient_insurances_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_intake_photos (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  submission_id uuid NOT NULL,
  patient_id uuid,
  photo_type text NOT NULL,
  area_name text,
  storage_path text NOT NULL,
  file_name text,
  mime_type text,
  file_size integer,
  uploaded_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_intake_photos_pkey PRIMARY KEY (id),
  CONSTRAINT patient_intake_photos_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id),
  CONSTRAINT patient_intake_photos_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_intake_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  submission_id uuid NOT NULL,
  patient_id uuid,
  preferred_language text DEFAULT 'en'::text,
  consultation_type text,
  preferred_contact_method text,
  preferred_contact_time text,
  additional_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_intake_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT patient_intake_preferences_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id),
  CONSTRAINT patient_intake_preferences_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_intake_submissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  status text NOT NULL DEFAULT 'in_progress'::text,
  current_step integer NOT NULL DEFAULT 1,
  started_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  consultation_category text,
  CONSTRAINT patient_intake_submissions_pkey PRIMARY KEY (id),
  CONSTRAINT patient_intake_submissions_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_measurements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  submission_id uuid NOT NULL,
  patient_id uuid,
  height_cm numeric,
  weight_kg numeric,
  bmi numeric,
  chest_cm numeric,
  waist_cm numeric,
  hips_cm numeric,
  other_measurements jsonb,
  measured_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_measurements_pkey PRIMARY KEY (id),
  CONSTRAINT patient_measurements_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id),
  CONSTRAINT patient_measurements_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_note_mentions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  note_id uuid NOT NULL,
  patient_id uuid NOT NULL,
  mentioned_user_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  CONSTRAINT patient_note_mentions_pkey PRIMARY KEY (id),
  CONSTRAINT patient_note_mentions_mentioned_user_id_fkey FOREIGN KEY (mentioned_user_id) REFERENCES public.users(id),
  CONSTRAINT patient_note_mentions_note_id_fkey FOREIGN KEY (note_id) REFERENCES public.patient_notes(id),
  CONSTRAINT patient_note_mentions_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  author_user_id uuid,
  author_name text,
  body text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT patient_notes_pkey PRIMARY KEY (id),
  CONSTRAINT patient_notes_author_user_id_fkey FOREIGN KEY (author_user_id) REFERENCES public.users(id),
  CONSTRAINT patient_notes_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_prescriptions (
  journal_entry_id uuid,
  patient_id uuid,
  mandator_id text,
  therapy_id uuid,
  prescription_line_id uuid,
  prescription_sheet_id uuid,
  ui_destination_tab character varying,
  product_name character varying,
  product_no character varying,
  product_type character varying,
  product_state character varying,
  amount_morning character varying,
  amount_noon character varying,
  amount_evening character varying,
  amount_night character varying,
  custom_dose text,
  quantity character varying,
  intake_kind character varying,
  intake_note text,
  intake_from_date timestamp with time zone,
  decision_summary text,
  show_in_mediplan boolean DEFAULT false,
  active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  CONSTRAINT patient_prescriptions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.patient_simulations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  submission_id uuid NOT NULL,
  patient_id uuid,
  simulation_type text,
  simulation_url text,
  storage_path text,
  status text DEFAULT 'pending'::text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_simulations_pkey PRIMARY KEY (id),
  CONSTRAINT patient_simulations_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id),
  CONSTRAINT patient_simulations_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_treatment_areas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  submission_id uuid NOT NULL,
  patient_id uuid,
  area_name text NOT NULL,
  area_category text,
  specific_concerns ARRAY,
  priority integer DEFAULT 1,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_treatment_areas_pkey PRIMARY KEY (id),
  CONSTRAINT patient_treatment_areas_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id),
  CONSTRAINT patient_treatment_areas_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patient_treatment_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  submission_id uuid NOT NULL,
  patient_id uuid,
  interested_treatments ARRAY,
  preferred_date_range_start date,
  preferred_date_range_end date,
  flexibility text,
  budget_range text,
  financing_interest boolean DEFAULT false,
  special_requests text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT patient_treatment_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT patient_treatment_preferences_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.patient_intake_submissions(id),
  CONSTRAINT patient_treatment_preferences_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  first_name text NOT NULL,
  last_name text NOT NULL,
  email text,
  phone text,
  dob date,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  source text DEFAULT 'manual'::text,
  marital_status text,
  nationality text,
  street_address text,
  postal_code text,
  town text,
  profession text,
  current_employer text,
  gender text CHECK (gender = ANY (ARRAY['male'::text, 'female'::text, 'other'::text])),
  avatar_url text,
  language_preference text,
  clinic_preference text,
  lifecycle_stage text,
  contact_owner_name text,
  contact_owner_email text,
  created_by_user_id uuid,
  created_by text,
  intake_submission_id uuid,
  intake_completed_at timestamp with time zone,
  country_code text DEFAULT '+41'::text,
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT patients_pkey PRIMARY KEY (id),
  CONSTRAINT patients_intake_submission_id_fkey FOREIGN KEY (intake_submission_id) REFERENCES public.patient_intake_submissions(id),
  CONSTRAINT patients_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.patients_master_stage (
  first_name text,
  last_name text,
  birth_date_text text
);
CREATE TABLE public.providers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  specialty text,
  email text,
  phone text,
  created_at timestamp with time zone DEFAULT now(),
  is_demo boolean NOT NULL DEFAULT false,
  gln text,
  zsr text,
  CONSTRAINT providers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.scheduled_emails (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  appointment_id uuid,
  recipient_type text NOT NULL,
  recipient_email text NOT NULL,
  subject text NOT NULL,
  body text NOT NULL,
  scheduled_for timestamp with time zone NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text,
  sent_at timestamp with time zone,
  error text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT scheduled_emails_pkey PRIMARY KEY (id),
  CONSTRAINT scheduled_emails_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT scheduled_emails_appointment_id_fkey FOREIGN KEY (appointment_id) REFERENCES public.appointments(id)
);
CREATE TABLE public.service_categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  sort_order integer NOT NULL DEFAULT 1,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT service_categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.service_group_services (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  group_id uuid NOT NULL,
  service_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  discount_percent numeric,
  quantity integer NOT NULL DEFAULT 1,
  CONSTRAINT service_group_services_pkey PRIMARY KEY (id),
  CONSTRAINT service_group_services_group_id_fkey FOREIGN KEY (group_id) REFERENCES public.service_groups(id),
  CONSTRAINT service_group_services_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id)
);
CREATE TABLE public.service_groups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  discount_percent numeric,
  CONSTRAINT service_groups_pkey PRIMARY KEY (id)
);
CREATE TABLE public.services (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  category_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  is_active boolean NOT NULL DEFAULT true,
  base_price numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  code text,
  CONSTRAINT services_pkey PRIMARY KEY (id),
  CONSTRAINT services_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.service_categories(id)
);
CREATE TABLE public.swiss_insurer_laws (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  insurer_id uuid NOT NULL,
  law_type text NOT NULL CHECK (law_type = ANY (ARRAY['KVG'::text, 'UVG'::text, 'IVG'::text, 'MVG'::text, 'VVG'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT swiss_insurer_laws_pkey PRIMARY KEY (id),
  CONSTRAINT swiss_insurer_laws_insurer_id_fkey FOREIGN KEY (insurer_id) REFERENCES public.swiss_insurers(id)
);
CREATE TABLE public.swiss_insurers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  gln text NOT NULL UNIQUE,
  bag_number text,
  name text NOT NULL,
  name_fr text,
  name_de text,
  address_street text,
  address_postal_code text,
  address_city text,
  address_canton text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  receiver_gln text,
  tp_allowed boolean DEFAULT true,
  CONSTRAINT swiss_insurers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.task_comment_mentions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  task_comment_id uuid NOT NULL,
  task_id uuid NOT NULL,
  mentioned_user_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  CONSTRAINT task_comment_mentions_pkey PRIMARY KEY (id),
  CONSTRAINT task_comment_mentions_mentioned_user_id_fkey FOREIGN KEY (mentioned_user_id) REFERENCES public.users(id),
  CONSTRAINT task_comment_mentions_task_comment_id_fkey FOREIGN KEY (task_comment_id) REFERENCES public.task_comments(id),
  CONSTRAINT task_comment_mentions_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id)
);
CREATE TABLE public.task_comments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  task_id uuid NOT NULL,
  author_user_id uuid,
  author_name text,
  body text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT task_comments_pkey PRIMARY KEY (id),
  CONSTRAINT task_comments_author_user_id_fkey FOREIGN KEY (author_user_id) REFERENCES public.users(id),
  CONSTRAINT task_comments_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id)
);
CREATE TABLE public.tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  name text NOT NULL,
  content text,
  status USER-DEFINED NOT NULL DEFAULT 'not_started'::task_status,
  priority USER-DEFINED NOT NULL DEFAULT 'medium'::task_priority,
  type USER-DEFINED NOT NULL DEFAULT 'todo'::task_type,
  activity_date timestamp with time zone,
  created_by_user_id uuid,
  created_by_name text,
  assigned_user_id uuid,
  assigned_user_name text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  assigned_read_at timestamp with time zone,
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT tasks_pkey PRIMARY KEY (id),
  CONSTRAINT tasks_assigned_user_id_fkey FOREIGN KEY (assigned_user_id) REFERENCES public.users(id),
  CONSTRAINT tasks_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id),
  CONSTRAINT tasks_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.tmp_appointments (
  start_at text,
  end_at text,
  sheet_id text,
  doctor_id text,
  doctor_name text,
  x_achilles_status_id text,
  category_id text,
  patient_id text,
  patient_email text,
  patient_phone text,
  patient_first_name text,
  patient_last_name text,
  nationality text,
  dob text,
  gender text,
  street_address text,
  postal_code text,
  town text,
  summary text,
  description text,
  manual_patient_info text,
  reason text
);
CREATE TABLE public.tmp_catalog_codes (
  catalog_name text,
  code text,
  price text
);
CREATE TABLE public.tmp_contacts (
  patient_id uuid NOT NULL,
  phone text,
  email text,
  dob date
);
CREATE TABLE public.tmp_deals (
  deal_uuid uuid NOT NULL DEFAULT gen_random_uuid(),
  owner_id uuid,
  owner_name text,
  created_at timestamp without time zone,
  deal_id uuid,
  CONSTRAINT tmp_deals_pkey PRIMARY KEY (deal_uuid)
);
CREATE TABLE public.tmp_invoice_import (
  executing_mandator_zsr text,
  catalog_valid_to text,
  care_provider_id text,
  invoice_status_change_date text,
  catalog_nature text,
  care_provider_name text,
  tp_tl text,
  description_de text,
  care_provider_suva text,
  uncovered_benefit text,
  care_provider_short_name text,
  code_on_invoice text,
  medical_case_subject text,
  responsible_mandator_zsr text,
  name_de text,
  catalog_name_it text,
  invoice_id text,
  tp_al_scale_factor text,
  body_half text,
  care_provider_gln text,
  responsible_mandator_id text,
  source_unaccounted_medical_benefit_id text,
  name_fr text,
  responsible_mandator_name text,
  tp_al_value text,
  executing_mandator_internal_contact_id text,
  responsible_mandator_color_code text,
  responsible_mandator_suva text,
  billing_group_name text,
  treatment_id text,
  care_provider_zsr text,
  vat_rate_value text,
  catalog_name_de text,
  health_insurance_law text,
  invoice_total text,
  invoice_total_raw text,
  treatment_date text,
  total_price_without_vat text,
  patient_id text,
  price_al text,
  effective_duration_minutes text,
  patient_last_name text,
  tarmed_time text,
  medical_case_no text,
  executing_mandator_color_code text,
  invoice_status text,
  catalog_version text,
  code text,
  description_fr text,
  responsible_mandator_gln text,
  source_instance_id text,
  accounted_medical_benefit_id text,
  executing_mandator_gln text,
  tp_al_or_price text,
  vat_amount text,
  tp_tl_value text,
  tariff_code text,
  executing_mandator_suva text,
  executing_mandator_name text,
  sort_order text,
  executing_mandator_id text,
  vat_rate text,
  case_differentiation_id text,
  executing_mandator_short_name text,
  catalog_name text,
  patient_birthdate text,
  medical_case_id text,
  patient_gender text,
  quantity text,
  responsible_mandator_nif text,
  total_price text,
  description_it text,
  invoice_no text,
  case_differentiation_name text,
  patient_first_name text,
  patient_number text,
  billing_group_id text,
  catalog_valid_from text,
  responsible_mandator_short_name text,
  responsible_mandator_internal_contact_id text,
  price_tl text,
  catalog_name_fr text,
  comment text,
  tp_tl_scale_factor text,
  name_it text,
  care_provider_nif text,
  html_content text,
  total_reconciled_fee text,
  collection_invoice text
);
CREATE TABLE public.tmp_invoice_raw (
  care_provider_canton text,
  invoicing_party_phone text,
  patient_streetno text,
  care_provider_id text,
  invoicing_party_salutation text,
  care_provider_suva_number text,
  refund_kind text,
  care_provider_email text,
  invoicing_party_last_name text,
  vat_rate_value_common text,
  medical_case_law text,
  medical_case_subject text,
  second_invoice_recipient_gln text,
  invoice_recipient_patient_guarant_insured_number text,
  second_invoice_recipient_company_department text,
  payment_details_account_iban text,
  assigner_address_address_addition text,
  second_invoice_recipient_zip_code text,
  second_invoice_recipient_canton text,
  invoicing_party_address_type text,
  assigner_address_canton text,
  invoicing_party_fax text,
  amount_vat_common text,
  second_invoice_recipient_contact_id text,
  payment_details_bank_name text,
  amount_vat_free text,
  invoice_recipient_company_gln text,
  total_raw text,
  invoicing_party_gln text,
  assigner_company_department text,
  care_provider_address_type text,
  assigner_address_po_box text,
  care_provider_street_no text,
  invoicing_party_zip text,
  care_provider_po_box text,
  assigner_address_salutation text,
  medical_case_no text,
  invoice_recipient_title text,
  invoicing_party_suva_number text,
  care_provider_address_addition text,
  amount_vat_free_factor text,
  invoice_balance_amount_uncovered_benefit text,
  invoice_recipient_company_name text,
  patient_pobox text,
  invoicing_party_company_addition text,
  payment_details_print_in_favor_text text,
  source_instance_id text,
  second_invoice_recipient_street_no text,
  payment_details_account_payment_recipient_address_line_1 text,
  payment_details_bank_address_zip_code text,
  payment_details_account_payment_recipient_address_line_2 text,
  invoice_recipient_firstname text,
  invoice_recipient_address_type text,
  invoicing_party_title text,
  current_invoice_status text,
  invoice_balance_amount_covered_benefit text,
  care_provider_salutation text,
  invoice_creation_date text,
  payment_details_account_method text,
  patient_language text,
  invoicing_party_mobile text,
  care_provider_vat_number text,
  current_dunning_status text,
  current_dunning_fees text,
  patient_lastname text,
  patient_firstname text,
  care_provider_street text,
  payment_details_print_vesr_customer_number text,
  assigner_address_street text,
  invoice_balance_total text,
  second_invoice_recipient_address_type text,
  latest_invoice_status_change_date text,
  amount_vat_reduced text,
  patient_gender text,
  care_provider_country_short text,
  medical_case_external_reference_number text,
  second_invoice_recipient_country text,
  medical_case_reason text,
  invoicing_party_first_name text,
  patient_guarant_insurance_card_number text,
  involved_mandator_ids text,
  invoice_recipient_company_addition text,
  current_amount_overpaid text,
  invoice_recipient_country text,
  assigner_address_street_no text,
  invoice_recipient_street_no text,
  invoice_notes text,
  care_provider_last_name text,
  invoicing_party_address_addition text,
  second_invoice_recipient_hmo_insurance_model_kind text,
  payment_details_in_favor_text text,
  patient_salutation text,
  invoicing_party_canton text,
  invoicing_party_city text,
  medical_case_site text,
  patient_ssn text,
  care_provider_city text,
  second_invoice_recipient_company_name text,
  invoice_recipient_canton text,
  care_provider_zip text,
  treatment_from_datetime text,
  invoicing_party_nif_number text,
  event_date text,
  care_provider_company_addition text,
  second_invoice_recipient_company_addition text,
  invoice_id text,
  invoicing_party_street_no text,
  care_provider_gln text,
  treatment_to_datetime text,
  payment_details_bank_address_city text,
  invoicing_party_po_box text,
  assigner_address_title text,
  invoice_recipient_zip_code text,
  invoicing_party_street text,
  payment_details_bsr_number text,
  assigner_address_lastname text,
  invoice_recipient_lastname text,
  payment_details_account_payment_recipient_name text,
  care_provider_zsr text,
  current_amount_paid text,
  care_provider_mobile text,
  amount_vat_reduced_factor text,
  patient_canton text,
  care_provider_role text,
  patient_id text,
  invoice_recipient_relation_type text,
  invoice_recipient_street text,
  payment_details_account_payment_recipient_country text,
  patient_title text,
  invoice_recipient_company_department text,
  patient_city text,
  payment_details_qr_invoice text,
  patient_zip text,
  assigner_address_gln text,
  payment_details_payment_term_text text,
  care_provider_company_name text,
  payment_details_payment_term_in_days text,
  invoicing_party_company_department text,
  second_invoice_recipient_street text,
  second_invoice_recipient_city text,
  care_provider_phone text,
  payment_details_additional_invoice_text text,
  invoicing_party_email text,
  assigner_address_firstname text,
  invoicing_party_company_name text,
  assigner_company_addition text,
  has_second_invoive_recipient text,
  invoice_recipient_salutation text,
  patient_street text,
  payment_details_bank_address_country text,
  payment_details_vesr_customer_number text,
  invoice_recipient_po_box text,
  assigner_address_zip_code text,
  payment_details_account_type text,
  second_invoice_recipient_po_box text,
  second_invoice_recipient_kvg_insurance_model text,
  invoicing_party_zsr text,
  patient_birthdate text,
  assigner_address_city text,
  patient_guarantor_insured_number text,
  invoice_recipient_contact_id text,
  invoice_recipient_hmo_insurance_model_kind text,
  invoice_no text,
  care_provider_fax text,
  care_provider_first_name text,
  amount_vat_common_factor text,
  assigner_address_type text,
  care_provider_company_department text,
  patient_country text,
  assigner_address_country text,
  current_amount_due text,
  invoice_recipient_address_addition text,
  invoice_recipient_kvg_insurance_model text,
  second_invoice_recipient_address_addition text,
  patient_number text,
  patient_address_addition text,
  care_provider_nif_number text,
  invoicing_party_country_short text,
  invoice_recipient_city text,
  assigner_comapny_name text,
  care_provider_title text,
  invoicing_party_vat_number text,
  vat_rate_value_reduced text
);
CREATE TABLE public.tmp_notes (
  author_id uuid,
  patient_id uuid,
  body text,
  updated timestamp without time zone,
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  CONSTRAINT tmp_notes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.tmp_patient_axenita (
  matched_patient_id uuid,
  axenita_id uuid
);
CREATE TABLE public.tmp_treatment_flat (
  patient_id text,
  treatment_id text,
  mandator_id text,
  treatment_date text,
  attached_treatment_title_id text,
  treatment_title_id text,
  treatment_title_name text,
  content text,
  updatedbyusername text,
  updateddatetime text,
  content_text text,
  mandator_short_name text,
  title text
);
CREATE TABLE public.user_availability (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL DEFAULT '08:00:00'::time without time zone,
  end_time time without time zone NOT NULL DEFAULT '19:00:00'::time without time zone,
  is_available boolean NOT NULL DEFAULT true,
  location text DEFAULT 'Geneva'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_availability_pkey PRIMARY KEY (id),
  CONSTRAINT user_availability_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL,
  role text NOT NULL DEFAULT 'staff'::text,
  created_at timestamp with time zone DEFAULT now(),
  full_name text,
  email text,
  designation text,
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.whatsapp_conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  phone_number text NOT NULL,
  last_message_at timestamp with time zone,
  last_message_preview text,
  unread_count integer DEFAULT 0,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT whatsapp_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT whatsapp_conversations_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.whatsapp_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  to_number text NOT NULL,
  from_number text,
  body text NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'queued'::whatsapp_status,
  direction USER-DEFINED NOT NULL DEFAULT 'outbound'::whatsapp_direction,
  provider_message_sid text,
  sent_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  is_demo boolean NOT NULL DEFAULT false,
  message_sid text,
  conversation_id text,
  template_id text,
  media_url text,
  error_message text,
  delivered_at timestamp with time zone,
  read_at timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT whatsapp_messages_pkey PRIMARY KEY (id),
  CONSTRAINT whatsapp_messages_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.whatsapp_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  category text NOT NULL DEFAULT 'MARKETING'::text,
  language text NOT NULL DEFAULT 'en'::text,
  body text NOT NULL,
  variables jsonb DEFAULT '[]'::jsonb,
  meta_template_id text,
  twilio_content_sid text,
  status text DEFAULT 'active'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT whatsapp_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.workflow_actions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid NOT NULL,
  action_type USER-DEFINED NOT NULL,
  config jsonb NOT NULL DEFAULT '{}'::jsonb,
  sort_order integer NOT NULL DEFAULT 1,
  CONSTRAINT workflow_actions_pkey PRIMARY KEY (id),
  CONSTRAINT workflow_actions_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.workflows(id)
);
CREATE TABLE public.workflow_enrollment_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  enrollment_id uuid NOT NULL,
  step_type text NOT NULL,
  step_action text,
  step_config jsonb,
  status text NOT NULL DEFAULT 'pending'::text,
  executed_at timestamp with time zone,
  result jsonb,
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT workflow_enrollment_steps_pkey PRIMARY KEY (id),
  CONSTRAINT workflow_enrollment_steps_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.workflow_enrollments(id)
);
CREATE TABLE public.workflow_enrollments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid NOT NULL,
  patient_id uuid NOT NULL,
  deal_id uuid,
  enrolled_at timestamp with time zone DEFAULT now(),
  status text NOT NULL DEFAULT 'active'::text,
  trigger_data jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT workflow_enrollments_pkey PRIMARY KEY (id),
  CONSTRAINT workflow_enrollments_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.workflows(id),
  CONSTRAINT workflow_enrollments_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT workflow_enrollments_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id)
);
CREATE TABLE public.workflows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  trigger_type USER-DEFINED NOT NULL,
  active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  config jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_demo boolean NOT NULL DEFAULT false,
  CONSTRAINT workflows_pkey PRIMARY KEY (id)
);